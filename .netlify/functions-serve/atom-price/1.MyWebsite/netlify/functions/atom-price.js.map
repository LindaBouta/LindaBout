{
  "version": 3,
  "sources": ["file:///E:/1.MyWebsite/netlify/functions/atom-price.js"],
  "sourceRoot": "C:/Users/linda/AppData/Local/Temp/tmp-16336-OlyHh2HTDd6C",
  "sourcesContent": ["// Netlify function: fetch live price/logo from Atom \"name\" pages with robust parsing.\r\n\r\nfunction atomUrlFromDomain(domain) {\r\n  const clean = String(domain || \"\").trim();\r\n  const isCom = /\\.com$/i.test(clean);\r\n  const slug = isCom ? clean.replace(/\\.com$/i, \"\") : clean; // ChicDrift.com -> ChicDrift\r\n  return `https://www.atom.com/name/${encodeURIComponent(slug)}`;\r\n}\r\n\r\nfunction safeJSONParse(s) {\r\n  try {\r\n    return JSON.parse(s);\r\n  } catch {\r\n    return null;\r\n  }\r\n}\r\n\r\nfunction* walk(obj) {\r\n  if (Array.isArray(obj)) {\r\n    for (const v of obj) yield* walk(v);\r\n  } else if (obj && typeof obj === \"object\") {\r\n    yield obj;\r\n    for (const k of Object.keys(obj)) yield* walk(obj[k]);\r\n  }\r\n}\r\n\r\nfunction parseFromJSONLD(html) {\r\n  // Grab all <script type=\"application/ld+json\"> blocks\r\n  const scripts = [...html.matchAll(/<script[^>]+type=[\"']application\\/ld\\+json[\"'][^>]*>([\\s\\S]*?)<\\/script>/gi)]\r\n    .map((m) => m[1]);\r\n\r\n  for (const raw of scripts) {\r\n    // Some sites embed multiple JSONs or HTML comments in one block\r\n    const candidates = raw\r\n      .split(\"</script>\")\r\n      .map((s) => s.trim())\r\n      .filter(Boolean);\r\n\r\n    for (const c of candidates) {\r\n      const j = safeJSONParse(c);\r\n      if (!j) continue;\r\n\r\n      for (const node of walk(j)) {\r\n        // Schema.org Product -> offers.price\r\n        if (node && node.offers && (node.offers.price || (node.offers[0] && node.offers[0].price))) {\r\n          const offer = Array.isArray(node.offers) ? node.offers[0] : node.offers;\r\n          const priceRaw = String(offer.price ?? \"\").trim();\r\n          if (priceRaw) {\r\n            const price = /^\\$/.test(priceRaw) ? priceRaw : `$${priceRaw}`;\r\n            return { price, isRequest: false };\r\n          }\r\n        }\r\n        // Sometimes there's a generic \"price\" field\r\n        if (node && typeof node.price !== \"undefined\") {\r\n          const priceRaw = String(node.price ?? \"\").trim();\r\n          if (priceRaw) {\r\n            const price = /^\\$/.test(priceRaw) ? priceRaw : `$${priceRaw}`;\r\n            return { price, isRequest: false };\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n  return null;\r\n}\r\n\r\nfunction parseFromMeta(html) {\r\n  // e.g. <meta itemprop=\"price\" content=\"1288\">\r\n  const m = html.match(/<meta[^>]+itemprop=[\"']price[\"'][^>]+content=[\"']([^\"']+)[\"']/i);\r\n  if (m) {\r\n    const raw = m[1].trim();\r\n    if (raw) return { price: /^\\$/.test(raw) ? raw : `$${raw}`, isRequest: false };\r\n  }\r\n  return null;\r\n}\r\n\r\nfunction parseFromPriceSpan(html) {\r\n  // Matches <span class=\"price-show\">\u2026</span> and similar\r\n  const m = html.match(/<span[^>]*class=[\"'][^\"']*price-show[^\"']*[\"'][^>]*>([\\s\\S]*?)<\\/span>/i);\r\n  if (m) {\r\n    const txt = m[1].replace(/<[^>]*>/g, \"\").trim();\r\n    if (/price\\s*request/i.test(txt) || /request\\s*price/i.test(txt)) {\r\n      return { price: \"Price Request\", isRequest: true };\r\n    }\r\n    if (/\\d/.test(txt)) return { price: txt, isRequest: false };\r\n  }\r\n  return null;\r\n}\r\n\r\nfunction parseFromDollarPattern(html) {\r\n  // As a final fallback, grab the first $1,234-like pattern near \u201Cprice\u201D\r\n  const blockMatch = html.match(/.{0,200}(price|amount|cost).{0,200}/i);\r\n  const block = blockMatch ? blockMatch[0] : html.slice(0, 2000);\r\n  const m = block.match(/\\$\\s?\\d[\\d,]*(?:\\.\\d{2})?/);\r\n  if (m) return { price: m[0].replace(/\\s+/g, \"\"), isRequest: false };\r\n  return null;\r\n}\r\n\r\nfunction parseLogo(html) {\r\n  // Prefer og:image\r\n  const og = html.match(/<meta[^>]+property=[\"']og:image[\"'][^>]+content=[\"']([^\"']+)[\"']/i);\r\n  if (og) return og[1];\r\n\r\n  // Fallback to first logo-image url\r\n  const img = html.match(/<img[^>]+src=[\"']([^\"']+logo-image[^\"']+)[\"'][^>]*>/i);\r\n  if (img) return img[1];\r\n\r\n  return undefined;\r\n}\r\n\r\nfunction parsePrice(html) {\r\n  // 1) Explicit \"Price Request\"\r\n  if (/Price\\s*Request/i.test(html) || /Request\\s*Price/i.test(html)) {\r\n    return { price: \"Price Request\", isRequest: true, logo: parseLogo(html) };\r\n  }\r\n\r\n  // 2) JSON-LD (most reliable when present)\r\n  const j = parseFromJSONLD(html);\r\n  if (j) return { ...j, logo: parseLogo(html) };\r\n\r\n  // 3) <meta itemprop=\"price\" content=\"...\">\r\n  const m = parseFromMeta(html);\r\n  if (m) return { ...m, logo: parseLogo(html) };\r\n\r\n  // 4) <span class=\"price-show\">...</span>\r\n  const s = parseFromPriceSpan(html);\r\n  if (s) return { ...s, logo: parseLogo(html) };\r\n\r\n  // 5) Dollar-pattern fallback\r\n  const d = parseFromDollarPattern(html);\r\n  if (d) return { ...d, logo: parseLogo(html) };\r\n\r\n  // Default\r\n  return { price: \"Price Request\", isRequest: true, logo: parseLogo(html) };\r\n}\r\n\r\nexports.handler = async (event) => {\r\n  const domain = (event.queryStringParameters?.domain || \"\").trim();\r\n  if (!domain) {\r\n    return { statusCode: 400, body: JSON.stringify({ error: \"Missing ?domain=example.com\" }) };\r\n  }\r\n\r\n  const url = atomUrlFromDomain(domain);\r\n\r\n  try {\r\n    const resp = await fetch(url, {\r\n      redirect: \"follow\",\r\n      headers: {\r\n        \"user-agent\":\r\n          \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120 Safari/537.36\",\r\n        accept: \"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\",\r\n        \"accept-language\": \"en-US,en;q=0.9\",\r\n        referer: \"https://www.atom.com/\",\r\n      },\r\n    });\r\n\r\n    if (!resp.ok) {\r\n      return {\r\n        statusCode: resp.status,\r\n        body: JSON.stringify({ error: `Upstream ${resp.status}`, url }),\r\n      };\r\n    }\r\n\r\n    const html = await resp.text();\r\n    const parsed = parsePrice(html);\r\n\r\n    // Short cache while testing (5 minutes). Raise later if you like.\r\n    return {\r\n      statusCode: 200,\r\n      headers: {\r\n        \"Content-Type\": \"application/json\",\r\n        \"Cache-Control\": \"s-maxage=300, stale-while-revalidate=3600\",\r\n      },\r\n      body: JSON.stringify({ domain, url, ...parsed }),\r\n    };\r\n  } catch (err) {\r\n    return {\r\n      statusCode: 500,\r\n      body: JSON.stringify({ error: \"Fetch failed\", message: String(err), url }),\r\n    };\r\n  }\r\n};\r\n"],
  "mappings": "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",
  "names": []
}
