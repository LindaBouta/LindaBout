{
  "version": 3,
  "sources": ["file:///E:/1.MyWebsite/netlify/functions/atom-prices-batch.js"],
  "sourceRoot": "C:/Users/linda/AppData/Local/Temp/tmp-16336-GgScD8wZXvlt",
  "sourcesContent": ["// netlify/functions/atom-prices-batch.js\r\n// Batch version: POST { domains: [\"ChicDrift.com\",\"ClimateFinance.io\", ...] }\r\n\r\nfunction atomUrlFromDomain(domain) {\r\n  const clean = String(domain || \"\").trim();\r\n  const isCom = /\\.com$/i.test(clean);\r\n  const slug = isCom ? clean.replace(/\\.com$/i, \"\") : clean; // ChicDrift.com -> ChicDrift\r\n  return `https://www.atom.com/name/${encodeURIComponent(slug)}`;\r\n}\r\n\r\nfunction safeJSONParse(s) {\r\n  try { return JSON.parse(s); } catch { return null; }\r\n}\r\n\r\nfunction* walk(obj) {\r\n  if (Array.isArray(obj)) for (const v of obj) yield* walk(v);\r\n  else if (obj && typeof obj === \"object\") {\r\n    yield obj;\r\n    for (const k of Object.keys(obj)) yield* walk(obj[k]);\r\n  }\r\n}\r\n\r\nfunction parseFromJSONLD(html) {\r\n  const scripts = [...html.matchAll(/<script[^>]+type=[\"']application\\/ld\\+json[\"'][^>]*>([\\s\\S]*?)<\\/script>/gi)]\r\n    .map((m) => m[1]);\r\n  for (const raw of scripts) {\r\n    const j = safeJSONParse(raw);\r\n    if (!j) continue;\r\n    for (const node of walk(j)) {\r\n      if (node && node.offers && (node.offers.price || (node.offers[0] && node.offers[0].price))) {\r\n        const offer = Array.isArray(node.offers) ? node.offers[0] : node.offers;\r\n        const priceRaw = String(offer.price ?? \"\").trim();\r\n        if (priceRaw) return { price: /^\\$/.test(priceRaw) ? priceRaw : `$${priceRaw}`, isRequest: false };\r\n      }\r\n      if (node && typeof node.price !== \"undefined\") {\r\n        const priceRaw = String(node.price ?? \"\").trim();\r\n        if (priceRaw) return { price: /^\\$/.test(priceRaw) ? priceRaw : `$${priceRaw}`, isRequest: false };\r\n      }\r\n    }\r\n  }\r\n  return null;\r\n}\r\n\r\nfunction parseFromMeta(html) {\r\n  const m = html.match(/<meta[^>]+itemprop=[\"']price[\"'][^>]+content=[\"']([^\"']+)[\"']/i);\r\n  if (m) {\r\n    const raw = m[1].trim();\r\n    if (raw) return { price: /^\\$/.test(raw) ? raw : `$${raw}`, isRequest: false };\r\n  }\r\n  return null;\r\n}\r\n\r\nfunction parseFromPriceSpan(html) {\r\n  const m = html.match(/<span[^>]*class=[\"'][^\"']*price-show[^\"']*[\"'][^>]*>([\\s\\S]*?)<\\/span>/i);\r\n  if (m) {\r\n    const txt = m[1].replace(/<[^>]*>/g, \"\").trim();\r\n    if (/price\\s*request/i.test(txt) || /request\\s*price/i.test(txt)) {\r\n      return { price: \"Price Request\", isRequest: true };\r\n    }\r\n    if (/\\d/.test(txt)) return { price: txt, isRequest: false };\r\n  }\r\n  return null;\r\n}\r\n\r\nfunction parseFromDollarPattern(html) {\r\n  const blockMatch = html.match(/.{0,200}(price|amount|cost).{0,200}/i);\r\n  const block = blockMatch ? blockMatch[0] : html.slice(0, 2000);\r\n  const m = block.match(/\\$\\s?\\d[\\d,]*(?:\\.\\d{2})?/);\r\n  if (m) return { price: m[0].replace(/\\s+/g, \"\"), isRequest: false };\r\n  return null;\r\n}\r\n\r\nfunction parseLogo(html) {\r\n  const og = html.match(/<meta[^>]+property=[\"']og:image[\"'][^>]+content=[\"']([^\"']+)[\"']/i);\r\n  if (og) return og[1];\r\n  const img = html.match(/<img[^>]+src=[\"']([^\"']+logo-image[^\"']+)[\"'][^>]*>/i);\r\n  if (img) return img[1];\r\n  return undefined;\r\n}\r\n\r\nfunction parsePrice(html) {\r\n  if (/Price\\s*Request/i.test(html) || /Request\\s*Price/i.test(html)) {\r\n    return { price: \"Price Request\", isRequest: true, logo: parseLogo(html) };\r\n  }\r\n  const j = parseFromJSONLD(html); if (j) return { ...j, logo: parseLogo(html) };\r\n  const m = parseFromMeta(html);   if (m) return { ...m, logo: parseLogo(html) };\r\n  const s = parseFromPriceSpan(html); if (s) return { ...s, logo: parseLogo(html) };\r\n  const d = parseFromDollarPattern(html); if (d) return { ...d, logo: parseLogo(html) };\r\n  return { price: \"Price Request\", isRequest: true, logo: parseLogo(html) };\r\n}\r\n\r\nasync function fetchOne(domain) {\r\n  const url = atomUrlFromDomain(domain);\r\n  try {\r\n    const resp = await fetch(url, {\r\n      redirect: \"follow\",\r\n      headers: {\r\n        \"user-agent\": \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120 Safari/537.36\",\r\n        accept: \"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\",\r\n        \"accept-language\": \"en-US,en;q=0.9\",\r\n        referer: \"https://www.atom.com/\",\r\n      },\r\n    });\r\n    if (!resp.ok) return { domain, url, error: `Upstream ${resp.status}` };\r\n    const html = await resp.text();\r\n    const parsed = parsePrice(html);\r\n    return { domain, url, ...parsed };\r\n  } catch (e) {\r\n    return { domain, url, error: \"Fetch failed\", message: String(e) };\r\n  }\r\n}\r\n\r\nexports.handler = async (event) => {\r\n  if (event.httpMethod !== \"POST\") {\r\n    return { statusCode: 405, body: JSON.stringify({ error: \"Use POST with JSON body\" }) };\r\n  }\r\n\r\n  let body;\r\n  try { body = JSON.parse(event.body || \"{}\"); } catch { body = {}; }\r\n  const domains = Array.isArray(body.domains) ? body.domains : [];\r\n\r\n  if (!domains.length) {\r\n    return { statusCode: 400, body: JSON.stringify({ error: \"Body must be { domains: [ ... ] }\" }) };\r\n  }\r\n\r\n  // Limit concurrency a bit (polite)\r\n  const MAX_PARALLEL = 6;\r\n  const queue = [...domains];\r\n  const results = [];\r\n\r\n  async function worker() {\r\n    while (queue.length) {\r\n      const d = queue.shift();\r\n      const r = await fetchOne(d);\r\n      results.push(r);\r\n      // small delay to be extra nice\r\n      await new Promise((res) => setTimeout(res, 120));\r\n    }\r\n  }\r\n\r\n  await Promise.all(Array.from({ length: Math.min(MAX_PARALLEL, domains.length) }, worker));\r\n\r\n  return {\r\n    statusCode: 200,\r\n    headers: {\r\n      \"Content-Type\": \"application/json\",\r\n      \"Cache-Control\": \"s-maxage=300, stale-while-revalidate=3600\",\r\n    },\r\n    body: JSON.stringify({ results }),\r\n  };\r\n};\r\n"],
  "mappings": "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",
  "names": []
}
